'use strict';

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _teen_process = require('teen_process');

var _appiumBaseDriver = require('appium-base-driver');

var _asyncbox = require('asyncbox');

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _installer = require('./installer');

var _adbkit = require('adbkit');

var _adbkit2 = _interopRequireDefault(_adbkit);

var _utils = require('./utils');

var REQD_PARAMS = ['adb', 'tmpDir', 'host', 'systemPort', 'devicePort'];
var SERVER_LAUNCH_RETRIES = 20;
var SERVER_INSTALL_RETRIES = 20;
var INSTRUMENTATION_TARGET = 'io.appium.uiautomator2.server.test/android.support.test.runner.AndroidJUnitRunner';

var UiAutomator2Server = (function () {
  function UiAutomator2Server() {
    var opts = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];

    _classCallCheck(this, UiAutomator2Server);

    var _iteratorNormalCompletion = true;
    var _didIteratorError = false;
    var _iteratorError = undefined;

    try {
      for (var _iterator = _getIterator(REQD_PARAMS), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
        var req = _step.value;

        if (!opts || !opts[req]) {
          throw new Error('Option \'' + req + '\' is required!');
        }
        this[req] = opts[req];
      }
    } catch (err) {
      _didIteratorError = true;
      _iteratorError = err;
    } finally {
      try {
        if (!_iteratorNormalCompletion && _iterator['return']) {
          _iterator['return']();
        }
      } finally {
        if (_didIteratorError) {
          throw _iteratorError;
        }
      }
    }

    this.jwproxy = new _appiumBaseDriver.JWProxy({ host: this.host, port: this.systemPort });
    this.proxyReqRes = this.jwproxy.proxyReqRes.bind(this.jwproxy);

    this.client = _adbkit2['default'].createClient({
      port: this.adb.adbPort
    });
  }

  _createClass(UiAutomator2Server, [{
    key: 'installServerApk',
    value: function installServerApk(installRetries) {
      var apkPackage, testApkPackage, isApkInstalled, isTestApkInstalled, apkVersion, pkgVersion, retries, output, _iteratorNormalCompletion2, _didIteratorError2, _iteratorError2, _iterator2, _step2, line;

      return _regeneratorRuntime.async(function installServerApk$(context$2$0) {
        var _this = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.getPackageName(_installer.UI2_SERVER_APK_PATH));

          case 2:
            apkPackage = context$2$0.sent;
            testApkPackage = apkPackage + '.test';
            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(this.adb.isAppInstalled(apkPackage));

          case 6:
            isApkInstalled = context$2$0.sent;
            context$2$0.next = 9;
            return _regeneratorRuntime.awrap(this.adb.isAppInstalled(testApkPackage));

          case 9:
            isTestApkInstalled = context$2$0.sent;

            if (!(isApkInstalled || isTestApkInstalled)) {
              context$2$0.next = 22;
              break;
            }

            context$2$0.next = 13;
            return _regeneratorRuntime.awrap(this.getAPKVersion(_installer.UI2_SERVER_APK_PATH));

          case 13:
            apkVersion = context$2$0.sent;
            context$2$0.next = 16;
            return _regeneratorRuntime.awrap(this.getInstalledPackageVersion(apkPackage));

          case 16:
            pkgVersion = context$2$0.sent;

            if (!(apkVersion !== pkgVersion)) {
              context$2$0.next = 22;
              break;
            }

            _logger2['default'].debug('Server installed but version ' + pkgVersion + ' instead of ' + apkVersion + '. Re-installing');
            isApkInstalled = isTestApkInstalled = false;
            context$2$0.next = 22;
            return _regeneratorRuntime.awrap(this.uninstallServerAndTest(apkPackage, testApkPackage));

          case 22:
            if (isApkInstalled) {
              context$2$0.next = 25;
              break;
            }

            context$2$0.next = 25;
            return _regeneratorRuntime.awrap(this.signAndInstall(_installer.UI2_SERVER_APK_PATH, apkPackage));

          case 25:
            if (isTestApkInstalled) {
              context$2$0.next = 28;
              break;
            }

            context$2$0.next = 28;
            return _regeneratorRuntime.awrap(this.signAndInstall(_installer.UI2_TEST_APK_PATH, testApkPackage, true));

          case 28:
            retries = (0, _utils.getRetries)('Server install', installRetries, SERVER_INSTALL_RETRIES);

            _logger2['default'].debug('Waiting up to ' + retries * 1000 + 'ms for instrumentation \'' + INSTRUMENTATION_TARGET + '\' to be available');
            output = undefined;
            context$2$0.prev = 31;
            context$2$0.next = 34;
            return _regeneratorRuntime.awrap((0, _asyncbox.retryInterval)(retries, 1000, function callee$2$0() {
              var err;
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    context$3$0.next = 2;
                    return _regeneratorRuntime.awrap(this.adb.shell(['pm', 'list', 'instrumentation']));

                  case 2:
                    output = context$3$0.sent;

                    if (!(output.indexOf('Could not access the Package Manager') !== -1)) {
                      context$3$0.next = 9;
                      break;
                    }

                    err = new Error('Problem running package manager: ' + output);

                    output = null; // remove output, so it is not printed below
                    throw err;

                  case 9:
                    if (!(output.indexOf(INSTRUMENTATION_TARGET) === -1)) {
                      context$3$0.next = 11;
                      break;
                    }

                    throw new Error('No instrumentation process found. Retrying...');

                  case 11:
                    _logger2['default'].debug('Instrumentation \'' + INSTRUMENTATION_TARGET + '\' available');

                  case 12:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this);
            }));

          case 34:
            context$2$0.next = 60;
            break;

          case 36:
            context$2$0.prev = 36;
            context$2$0.t0 = context$2$0['catch'](31);

            _logger2['default'].error('Unable to find instrumentation target \'' + INSTRUMENTATION_TARGET + '\': ' + context$2$0.t0.message);

            if (!output) {
              context$2$0.next = 60;
              break;
            }

            _logger2['default'].debug('Available targets:');
            _iteratorNormalCompletion2 = true;
            _didIteratorError2 = false;
            _iteratorError2 = undefined;
            context$2$0.prev = 44;
            for (_iterator2 = _getIterator(output.split('\n')); !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
              line = _step2.value;

              _logger2['default'].debug('    ' + line.replace('instrumentation:', ''));
            }
            context$2$0.next = 52;
            break;

          case 48:
            context$2$0.prev = 48;
            context$2$0.t1 = context$2$0['catch'](44);
            _didIteratorError2 = true;
            _iteratorError2 = context$2$0.t1;

          case 52:
            context$2$0.prev = 52;
            context$2$0.prev = 53;

            if (!_iteratorNormalCompletion2 && _iterator2['return']) {
              _iterator2['return']();
            }

          case 55:
            context$2$0.prev = 55;

            if (!_didIteratorError2) {
              context$2$0.next = 58;
              break;
            }

            throw _iteratorError2;

          case 58:
            return context$2$0.finish(55);

          case 59:
            return context$2$0.finish(52);

          case 60:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[31, 36], [44, 48, 52, 60], [53,, 55, 59]]);
    }
  }, {
    key: 'uninstallServerAndTest',
    value: function uninstallServerAndTest(apkPackage, testApkPackage) {
      return _regeneratorRuntime.async(function uninstallServerAndTest$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.prev = 0;
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.adb.uninstallApk(apkPackage));

          case 3:
            context$2$0.next = 9;
            break;

          case 5:
            context$2$0.prev = 5;
            context$2$0.t0 = context$2$0['catch'](0);

            _logger2['default'].warn('Error uninstalling \'' + apkPackage + '\': ' + context$2$0.t0.message);
            _logger2['default'].debug('Continuing');

          case 9:
            context$2$0.prev = 9;
            context$2$0.next = 12;
            return _regeneratorRuntime.awrap(this.adb.uninstallApk(testApkPackage));

          case 12:
            context$2$0.next = 18;
            break;

          case 14:
            context$2$0.prev = 14;
            context$2$0.t1 = context$2$0['catch'](9);

            _logger2['default'].warn('Error uninstalling \'' + testApkPackage + '\': ' + context$2$0.t1.message);
            _logger2['default'].debug('Continuing');

          case 18:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[0, 5], [9, 14]]);
    }
  }, {
    key: 'signAndInstall',
    value: function signAndInstall(apk, apkPackage) {
      var test = arguments.length <= 2 || arguments[2] === undefined ? false : arguments[2];
      return _regeneratorRuntime.async(function signAndInstall$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.checkAndSignCert(apk, apkPackage));

          case 2:
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.adb.install(apk));

          case 4:
            _logger2['default'].info('Installed UiAutomator2 server' + (test ? ' test' : '') + ' apk');

          case 5:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'getPackageName',
    value: function getPackageName(apk) {
      var args, _ref, stdout, apkPackage;

      return _regeneratorRuntime.async(function getPackageName$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            args = ['dump', 'badging', apk];
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.adb.initAapt());

          case 3:
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap((0, _teen_process.exec)(this.adb.binaries.aapt, args));

          case 5:
            _ref = context$2$0.sent;
            stdout = _ref.stdout;
            apkPackage = new RegExp(/package: name='([^']+)'/g).exec(stdout);

            if (apkPackage && apkPackage.length >= 2) {
              apkPackage = apkPackage[1];
            } else {
              apkPackage = null;
            }
            return context$2$0.abrupt('return', apkPackage);

          case 10:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'getAPKVersion',
    value: function getAPKVersion(apk) {
      var args, _ref2, stdout, apkVersion;

      return _regeneratorRuntime.async(function getAPKVersion$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            args = ['dump', 'badging', apk];
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.adb.initAapt());

          case 3:
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap((0, _teen_process.exec)(this.adb.binaries.aapt, args));

          case 5:
            _ref2 = context$2$0.sent;
            stdout = _ref2.stdout;
            apkVersion = new RegExp(/versionName='([^']+)'/g).exec(stdout);

            if (apkVersion && apkVersion.length >= 2) {
              apkVersion = apkVersion[1];
            } else {
              apkVersion = null;
            }
            return context$2$0.abrupt('return', apkVersion.toString());

          case 10:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'getInstalledPackageVersion',
    value: function getInstalledPackageVersion(pkg) {
      var stdout, pkgVersion;
      return _regeneratorRuntime.async(function getInstalledPackageVersion$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.adb.shell(['dumpsys', 'package', pkg]));

          case 2:
            stdout = context$2$0.sent;
            pkgVersion = new RegExp(/versionName=([^\s\s]+)/g).exec(stdout);

            if (pkgVersion && pkgVersion.length >= 2) {
              pkgVersion = pkgVersion[1];
            } else {
              pkgVersion = null;
            }
            return context$2$0.abrupt('return', pkgVersion.toString());

          case 6:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'checkAndSignCert',
    value: function checkAndSignCert(apk, apkPackage) {
      var signed;
      return _regeneratorRuntime.async(function checkAndSignCert$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.adb.checkApkCert(apk, apkPackage));

          case 2:
            signed = context$2$0.sent;

            if (signed) {
              context$2$0.next = 6;
              break;
            }

            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(this.adb.sign(apk));

          case 6:
            return context$2$0.abrupt('return', !signed);

          case 7:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'startSession',
    value: function startSession(caps) {
      var retries;
      return _regeneratorRuntime.async(function startSession$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.killUiAutomatorOnDevice());

          case 2:

            _logger2['default'].info('Starting uiautomator2 server ' + _installer.UI2_VER);

            // let cmd = ['am', 'instrument', '-w',
            //   'io.appium.uiautomator2.server.test/android.support.test.runner.AndroidJUnitRunner'];
            // this.adb.shell(cmd);
            // using 3rd party module called 'adbKit' for time being as using 'appium-adb'
            // facing IllegalStateException: UiAutomation not connected exception
            // https://github.com/appium/appium-uiautomator2-driver/issues/19

            context$2$0.next = 5;
            return _regeneratorRuntime.awrap(this.startSessionUsingAdbKit(caps.deviceUDID));

          case 5:
            retries = (0, _utils.getRetries)('Server launch', caps.uiautomator2ServerLaunchTimeout, SERVER_LAUNCH_RETRIES);

            _logger2['default'].info('Waiting up to ' + retries * 1000 + 'ms for UiAutomator2 to be online...');
            // wait for UiAutomator2 to be online
            context$2$0.next = 9;
            return _regeneratorRuntime.awrap((0, _asyncbox.retryInterval)(retries, 1000, this.jwproxy.command.bind(this.jwproxy), '/status', 'GET'));

          case 9:
            context$2$0.next = 11;
            return _regeneratorRuntime.awrap(this.jwproxy.command('/session', 'POST', { desiredCapabilities: caps }));

          case 11:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'startSessionUsingAdbKit',
    value: function startSessionUsingAdbKit(deviceUDID) {
      return _regeneratorRuntime.async(function startSessionUsingAdbKit$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].info('Running command: \'adb -s ' + deviceUDID + ' shell am instrument -w ' + INSTRUMENTATION_TARGET + '\'');
            this.client.shell(deviceUDID, 'am instrument -w ' + INSTRUMENTATION_TARGET).then(_adbkit2['default'].util.readAll).then(function (output) {
              var _iteratorNormalCompletion3 = true;
              var _didIteratorError3 = false;
              var _iteratorError3 = undefined;

              try {
                for (var _iterator3 = _getIterator(output.toString().split('\n')), _step3; !(_iteratorNormalCompletion3 = (_step3 = _iterator3.next()).done); _iteratorNormalCompletion3 = true) {
                  var line = _step3.value;

                  if (line.length) {
                    _logger2['default'].debug('[UIAutomator2] ' + line);
                  }
                }
              } catch (err) {
                _didIteratorError3 = true;
                _iteratorError3 = err;
              } finally {
                try {
                  if (!_iteratorNormalCompletion3 && _iterator3['return']) {
                    _iterator3['return']();
                  }
                } finally {
                  if (_didIteratorError3) {
                    throw _iteratorError3;
                  }
                }
              }
            })['catch'](function (err) {
              _logger2['default'].error('[UIAutomator2 Error] ' + err.message);
              _logger2['default'].debug('Full error: ' + err.stack);
            });

          case 2:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'deleteSession',
    value: function deleteSession() {
      return _regeneratorRuntime.async(function deleteSession$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Deleting UiAutomator2 server session');
            // rely on jwproxy's intelligence to know what we're talking about and
            // delete the current session
            context$2$0.prev = 1;
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.jwproxy.command('/', 'DELETE'));

          case 4:
            context$2$0.next = 9;
            break;

          case 6:
            context$2$0.prev = 6;
            context$2$0.t0 = context$2$0['catch'](1);

            _logger2['default'].warn('Did not get confirmation UiAutomator2 deleteSession worked; ' + ('Error was: ' + context$2$0.t0));

          case 9:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[1, 6]]);
    }
  }, {
    key: 'killUiAutomatorOnDevice',
    value: function killUiAutomatorOnDevice() {
      return _regeneratorRuntime.async(function killUiAutomatorOnDevice$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.prev = 0;
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.adb.forceStop('io.appium.uiautomator2.server'));

          case 3:
            context$2$0.next = 8;
            break;

          case 5:
            context$2$0.prev = 5;
            context$2$0.t0 = context$2$0['catch'](0);

            _logger2['default'].info("Unable to kill the io.appium.uiautomator2.server process, assuming it is already killed");

          case 8:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[0, 5]]);
    }
  }]);

  return UiAutomator2Server;
})();

exports['default'] = UiAutomator2Server;
module.exports = exports['default'];

// Installs the apks on to the device or emulator

// appending .test to apkPackage name to get test apk package name

//check server apk versionName

// kill any uiautomator existing processes
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi91aWF1dG9tYXRvcjIuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs0QkFBcUIsY0FBYzs7Z0NBQ1gsb0JBQW9COzt3QkFDZCxVQUFVOztzQkFDckIsVUFBVTs7Ozt5QkFDNEQsYUFBYTs7c0JBQ25GLFFBQVE7Ozs7cUJBQ0EsU0FBUzs7QUFHcEMsSUFBTSxXQUFXLEdBQUcsQ0FBQyxLQUFLLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBRSxZQUFZLEVBQUUsWUFBWSxDQUFDLENBQUM7QUFDMUUsSUFBTSxxQkFBcUIsR0FBRyxFQUFFLENBQUM7QUFDakMsSUFBTSxzQkFBc0IsR0FBRyxFQUFFLENBQUM7QUFDbEMsSUFBTSxzQkFBc0IsR0FBRyxtRkFBbUYsQ0FBQzs7SUFFN0csa0JBQWtCO0FBQ1YsV0FEUixrQkFBa0IsR0FDRTtRQUFYLElBQUkseURBQUcsRUFBRTs7MEJBRGxCLGtCQUFrQjs7Ozs7OztBQUVwQix3Q0FBZ0IsV0FBVyw0R0FBRTtZQUFwQixHQUFHOztBQUNWLFlBQUksQ0FBQyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUU7QUFDdkIsZ0JBQU0sSUFBSSxLQUFLLGVBQVksR0FBRyxxQkFBaUIsQ0FBQztTQUNqRDtBQUNELFlBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7T0FDdkI7Ozs7Ozs7Ozs7Ozs7Ozs7QUFDRCxRQUFJLENBQUMsT0FBTyxHQUFHLDhCQUFZLEVBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxVQUFVLEVBQUMsQ0FBQyxDQUFDO0FBQ3JFLFFBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQzs7QUFFL0QsUUFBSSxDQUFDLE1BQU0sR0FBRyxvQkFBTyxZQUFZLENBQUM7QUFD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Ozs7OztBQUN0QixtREFBaUIsTUFBTSxDQUFDLFFBQVEsRUFBRSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsaUhBQUU7c0JBQXZDLElBQUk7O0FBQ1gsc0JBQUksSUFBSSxDQUFDLE1BQU0sRUFBRTtBQUNmLHdDQUFPLEtBQUsscUJBQW1CLElBQUksQ0FBRyxDQUFDO21CQUN4QztpQkFDRjs7Ozs7Ozs7Ozs7Ozs7O2FBQ0YsQ0FBQyxTQUFNLENBQUMsVUFBVSxHQUFHLEVBQUU7QUFDdEIsa0NBQU8sS0FBSywyQkFBeUIsR0FBRyxDQUFDLE9BQU8sQ0FBRyxDQUFDO0FBQ3BELGtDQUFPLEtBQUssa0JBQWdCLEdBQUcsQ0FBQyxLQUFLLENBQUcsQ0FBQzthQUMxQyxDQUFDLENBQUM7Ozs7Ozs7S0FDTjs7O1dBRW1COzs7O0FBQ2xCLGdDQUFPLEtBQUssQ0FBQyxzQ0FBc0MsQ0FBQyxDQUFDOzs7Ozs2Q0FJN0MsSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLFFBQVEsQ0FBQzs7Ozs7Ozs7OztBQUV6QyxnQ0FBTyxJQUFJLENBQUMsaUdBQ1csQ0FBQyxDQUFDOzs7Ozs7O0tBRTVCOzs7V0FFNkI7Ozs7Ozs2Q0FFcEIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsK0JBQStCLENBQUM7Ozs7Ozs7Ozs7QUFFekQsZ0NBQU8sSUFBSSxDQUFDLHlGQUF5RixDQUFDLENBQUM7Ozs7Ozs7S0FFMUc7OztTQS9MRyxrQkFBa0I7OztxQkFrTVQsa0JBQWtCIiwiZmlsZSI6ImxpYi91aWF1dG9tYXRvcjIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCB7IEpXUHJveHkgfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuaW1wb3J0IHsgcmV0cnlJbnRlcnZhbCB9IGZyb20gJ2FzeW5jYm94JztcbmltcG9ydCBsb2dnZXIgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHsgVUkyX1NFUlZFUl9BUEtfUEFUSCBhcyBhcGtQYXRoLCBVSTJfVEVTVF9BUEtfUEFUSCBhcyB0ZXN0QXBrUGF0aCwgVUkyX1ZFUn0gZnJvbSAnLi9pbnN0YWxsZXInO1xuaW1wb3J0IGFkYmtpdCBmcm9tICdhZGJraXQnO1xuaW1wb3J0IHsgZ2V0UmV0cmllcyB9IGZyb20gJy4vdXRpbHMnO1xuXG5cbmNvbnN0IFJFUURfUEFSQU1TID0gWydhZGInLCAndG1wRGlyJywgJ2hvc3QnLCAnc3lzdGVtUG9ydCcsICdkZXZpY2VQb3J0J107XG5jb25zdCBTRVJWRVJfTEFVTkNIX1JFVFJJRVMgPSAyMDtcbmNvbnN0IFNFUlZFUl9JTlNUQUxMX1JFVFJJRVMgPSAyMDtcbmNvbnN0IElOU1RSVU1FTlRBVElPTl9UQVJHRVQgPSAnaW8uYXBwaXVtLnVpYXV0b21hdG9yMi5zZXJ2ZXIudGVzdC9hbmRyb2lkLnN1cHBvcnQudGVzdC5ydW5uZXIuQW5kcm9pZEpVbml0UnVubmVyJztcblxuY2xhc3MgVWlBdXRvbWF0b3IyU2VydmVyIHtcbiAgY29uc3RydWN0b3IgKG9wdHMgPSB7fSkge1xuICAgIGZvciAobGV0IHJlcSBvZiBSRVFEX1BBUkFNUykge1xuICAgICAgaWYgKCFvcHRzIHx8ICFvcHRzW3JlcV0pIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBPcHRpb24gJyR7cmVxfScgaXMgcmVxdWlyZWQhYCk7XG4gICAgICB9XG4gICAgICB0aGlzW3JlcV0gPSBvcHRzW3JlcV07XG4gICAgfVxuICAgIHRoaXMuandwcm94eSA9IG5ldyBKV1Byb3h5KHtob3N0OiB0aGlzLmhvc3QsIHBvcnQ6IHRoaXMuc3lzdGVtUG9ydH0pO1xuICAgIHRoaXMucHJveHlSZXFSZXMgPSB0aGlzLmp3cHJveHkucHJveHlSZXFSZXMuYmluZCh0aGlzLmp3cHJveHkpO1xuXG4gICAgdGhpcy5jbGllbnQgPSBhZGJraXQuY3JlYXRlQ2xpZW50KHtcbiAgICAgIHBvcnQ6IHRoaXMuYWRiLmFkYlBvcnQsXG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBpbnN0YWxsU2VydmVyQXBrIChpbnN0YWxsUmV0cmllcykge1xuICAgIC8vIEluc3RhbGxzIHRoZSBhcGtzIG9uIHRvIHRoZSBkZXZpY2Ugb3IgZW11bGF0b3JcbiAgICBsZXQgYXBrUGFja2FnZSA9IGF3YWl0IHRoaXMuZ2V0UGFja2FnZU5hbWUoYXBrUGF0aCk7XG4gICAgLy8gYXBwZW5kaW5nIC50ZXN0IHRvIGFwa1BhY2thZ2UgbmFtZSB0byBnZXQgdGVzdCBhcGsgcGFja2FnZSBuYW1lXG4gICAgbGV0IHRlc3RBcGtQYWNrYWdlID0gYCR7YXBrUGFja2FnZX0udGVzdGA7XG4gICAgbGV0IGlzQXBrSW5zdGFsbGVkID0gYXdhaXQgdGhpcy5hZGIuaXNBcHBJbnN0YWxsZWQoYXBrUGFja2FnZSk7XG4gICAgbGV0IGlzVGVzdEFwa0luc3RhbGxlZCA9IGF3YWl0IHRoaXMuYWRiLmlzQXBwSW5zdGFsbGVkKHRlc3RBcGtQYWNrYWdlKTtcbiAgICBpZiAoaXNBcGtJbnN0YWxsZWQgfHwgaXNUZXN0QXBrSW5zdGFsbGVkKSB7XG4gICAgICAvL2NoZWNrIHNlcnZlciBhcGsgdmVyc2lvbk5hbWVcbiAgICAgIGxldCBhcGtWZXJzaW9uID0gYXdhaXQgdGhpcy5nZXRBUEtWZXJzaW9uKGFwa1BhdGgpO1xuICAgICAgbGV0IHBrZ1ZlcnNpb24gPSBhd2FpdCB0aGlzLmdldEluc3RhbGxlZFBhY2thZ2VWZXJzaW9uKGFwa1BhY2thZ2UpO1xuICAgICAgaWYgKGFwa1ZlcnNpb24gIT09IHBrZ1ZlcnNpb24pIHtcbiAgICAgICAgbG9nZ2VyLmRlYnVnKGBTZXJ2ZXIgaW5zdGFsbGVkIGJ1dCB2ZXJzaW9uICR7cGtnVmVyc2lvbn0gaW5zdGVhZCBvZiAke2Fwa1ZlcnNpb259LiBSZS1pbnN0YWxsaW5nYCk7XG4gICAgICAgIGlzQXBrSW5zdGFsbGVkID0gaXNUZXN0QXBrSW5zdGFsbGVkID0gZmFsc2U7XG4gICAgICAgIGF3YWl0IHRoaXMudW5pbnN0YWxsU2VydmVyQW5kVGVzdChhcGtQYWNrYWdlLCB0ZXN0QXBrUGFja2FnZSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKCFpc0Fwa0luc3RhbGxlZCkge1xuICAgICAgYXdhaXQgdGhpcy5zaWduQW5kSW5zdGFsbChhcGtQYXRoLCBhcGtQYWNrYWdlKTtcbiAgICB9XG4gICAgaWYgKCFpc1Rlc3RBcGtJbnN0YWxsZWQpIHtcbiAgICAgIGF3YWl0IHRoaXMuc2lnbkFuZEluc3RhbGwodGVzdEFwa1BhdGgsIHRlc3RBcGtQYWNrYWdlLCB0cnVlKTtcbiAgICB9XG5cbiAgICBsZXQgcmV0cmllcyA9IGdldFJldHJpZXMoJ1NlcnZlciBpbnN0YWxsJywgaW5zdGFsbFJldHJpZXMsIFNFUlZFUl9JTlNUQUxMX1JFVFJJRVMpO1xuXG4gICAgbG9nZ2VyLmRlYnVnKGBXYWl0aW5nIHVwIHRvICR7cmV0cmllcyAqIDEwMDB9bXMgZm9yIGluc3RydW1lbnRhdGlvbiAnJHtJTlNUUlVNRU5UQVRJT05fVEFSR0VUfScgdG8gYmUgYXZhaWxhYmxlYCk7XG4gICAgbGV0IG91dHB1dDtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgcmV0cnlJbnRlcnZhbChyZXRyaWVzLCAxMDAwLCBhc3luYyAoKSA9PiB7XG4gICAgICAgIG91dHB1dCA9IGF3YWl0IHRoaXMuYWRiLnNoZWxsKFsncG0nLCAnbGlzdCcsICdpbnN0cnVtZW50YXRpb24nXSk7XG4gICAgICAgIGlmIChvdXRwdXQuaW5kZXhPZignQ291bGQgbm90IGFjY2VzcyB0aGUgUGFja2FnZSBNYW5hZ2VyJykgIT09IC0xKSB7XG4gICAgICAgICAgbGV0IGVyciA9IG5ldyBFcnJvcihgUHJvYmxlbSBydW5uaW5nIHBhY2thZ2UgbWFuYWdlcjogJHtvdXRwdXR9YCk7XG4gICAgICAgICAgb3V0cHV0ID0gbnVsbDsgLy8gcmVtb3ZlIG91dHB1dCwgc28gaXQgaXMgbm90IHByaW50ZWQgYmVsb3dcbiAgICAgICAgICB0aHJvdyBlcnI7XG4gICAgICAgIH0gZWxzZSBpZiAob3V0cHV0LmluZGV4T2YoSU5TVFJVTUVOVEFUSU9OX1RBUkdFVCkgPT09IC0xKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdObyBpbnN0cnVtZW50YXRpb24gcHJvY2VzcyBmb3VuZC4gUmV0cnlpbmcuLi4nKTtcbiAgICAgICAgfVxuICAgICAgICBsb2dnZXIuZGVidWcoYEluc3RydW1lbnRhdGlvbiAnJHtJTlNUUlVNRU5UQVRJT05fVEFSR0VUfScgYXZhaWxhYmxlYCk7XG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZ2dlci5lcnJvcihgVW5hYmxlIHRvIGZpbmQgaW5zdHJ1bWVudGF0aW9uIHRhcmdldCAnJHtJTlNUUlVNRU5UQVRJT05fVEFSR0VUfSc6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgICBpZiAob3V0cHV0KSB7XG4gICAgICAgIGxvZ2dlci5kZWJ1ZygnQXZhaWxhYmxlIHRhcmdldHM6Jyk7XG4gICAgICAgIGZvciAobGV0IGxpbmUgb2Ygb3V0cHV0LnNwbGl0KCdcXG4nKSkge1xuICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhgICAgICR7bGluZS5yZXBsYWNlKCdpbnN0cnVtZW50YXRpb246JywgJycpfWApO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgdW5pbnN0YWxsU2VydmVyQW5kVGVzdCAoYXBrUGFja2FnZSwgdGVzdEFwa1BhY2thZ2UpIHtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5hZGIudW5pbnN0YWxsQXBrKGFwa1BhY2thZ2UpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nZ2VyLndhcm4oYEVycm9yIHVuaW5zdGFsbGluZyAnJHthcGtQYWNrYWdlfSc6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgICBsb2dnZXIuZGVidWcoJ0NvbnRpbnVpbmcnKTtcbiAgICB9XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMuYWRiLnVuaW5zdGFsbEFwayh0ZXN0QXBrUGFja2FnZSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2dnZXIud2FybihgRXJyb3IgdW5pbnN0YWxsaW5nICcke3Rlc3RBcGtQYWNrYWdlfSc6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgICBsb2dnZXIuZGVidWcoJ0NvbnRpbnVpbmcnKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBzaWduQW5kSW5zdGFsbCAoYXBrLCBhcGtQYWNrYWdlLCB0ZXN0ID0gZmFsc2UpIHtcbiAgICBhd2FpdCB0aGlzLmNoZWNrQW5kU2lnbkNlcnQoYXBrLCBhcGtQYWNrYWdlKTtcbiAgICBhd2FpdCB0aGlzLmFkYi5pbnN0YWxsKGFwayk7XG4gICAgbG9nZ2VyLmluZm8oYEluc3RhbGxlZCBVaUF1dG9tYXRvcjIgc2VydmVyJHt0ZXN0ID8gJyB0ZXN0JyA6ICcnfSBhcGtgKTtcbiAgfVxuXG4gIGFzeW5jIGdldFBhY2thZ2VOYW1lIChhcGspIHtcbiAgICBsZXQgYXJncyA9IFsnZHVtcCcsICdiYWRnaW5nJywgYXBrXTtcbiAgICBhd2FpdCB0aGlzLmFkYi5pbml0QWFwdCgpO1xuICAgIGxldCB7c3Rkb3V0fSA9IGF3YWl0IGV4ZWModGhpcy5hZGIuYmluYXJpZXMuYWFwdCwgYXJncyk7XG4gICAgbGV0IGFwa1BhY2thZ2UgPSBuZXcgUmVnRXhwKC9wYWNrYWdlOiBuYW1lPScoW14nXSspJy9nKS5leGVjKHN0ZG91dCk7XG4gICAgaWYgKGFwa1BhY2thZ2UgJiYgYXBrUGFja2FnZS5sZW5ndGggPj0gMikge1xuICAgICAgYXBrUGFja2FnZSA9IGFwa1BhY2thZ2VbMV07XG4gICAgfSBlbHNlIHtcbiAgICAgIGFwa1BhY2thZ2UgPSBudWxsO1xuICAgIH1cbiAgICByZXR1cm4gYXBrUGFja2FnZTtcbiAgfVxuXG4gIGFzeW5jIGdldEFQS1ZlcnNpb24gKGFwaykge1xuICAgIGxldCBhcmdzID0gWydkdW1wJywgJ2JhZGdpbmcnLCBhcGtdO1xuICAgIGF3YWl0IHRoaXMuYWRiLmluaXRBYXB0KCk7XG4gICAgbGV0IHtzdGRvdXR9ID0gYXdhaXQgZXhlYyh0aGlzLmFkYi5iaW5hcmllcy5hYXB0LCBhcmdzKTtcbiAgICBsZXQgYXBrVmVyc2lvbiA9IG5ldyBSZWdFeHAoL3ZlcnNpb25OYW1lPScoW14nXSspJy9nKS5leGVjKHN0ZG91dCk7XG4gICAgaWYgKGFwa1ZlcnNpb24gJiYgYXBrVmVyc2lvbi5sZW5ndGggPj0gMikge1xuICAgICAgYXBrVmVyc2lvbiA9IGFwa1ZlcnNpb25bMV07XG4gICAgfSBlbHNlIHtcbiAgICAgIGFwa1ZlcnNpb24gPSBudWxsO1xuICAgIH1cbiAgICByZXR1cm4gYXBrVmVyc2lvbi50b1N0cmluZygpO1xuICB9XG5cbiAgYXN5bmMgZ2V0SW5zdGFsbGVkUGFja2FnZVZlcnNpb24gKHBrZykge1xuICAgIGxldCBzdGRvdXQgPSAgYXdhaXQgdGhpcy5hZGIuc2hlbGwoWydkdW1wc3lzJywgJ3BhY2thZ2UnLCBwa2ddKTtcbiAgICBsZXQgcGtnVmVyc2lvbiA9IG5ldyBSZWdFeHAoL3ZlcnNpb25OYW1lPShbXlxcc1xcc10rKS9nKS5leGVjKHN0ZG91dCk7XG4gICAgaWYgKHBrZ1ZlcnNpb24gJiYgcGtnVmVyc2lvbi5sZW5ndGggPj0gMikge1xuICAgICAgcGtnVmVyc2lvbiA9IHBrZ1ZlcnNpb25bMV07XG4gICAgfSBlbHNlIHtcbiAgICAgIHBrZ1ZlcnNpb24gPSBudWxsO1xuICAgIH1cbiAgICByZXR1cm4gcGtnVmVyc2lvbi50b1N0cmluZygpO1xuICB9XG5cbiAgYXN5bmMgY2hlY2tBbmRTaWduQ2VydCAoYXBrLCBhcGtQYWNrYWdlKSB7XG4gICAgbGV0IHNpZ25lZCA9IGF3YWl0IHRoaXMuYWRiLmNoZWNrQXBrQ2VydChhcGssIGFwa1BhY2thZ2UpO1xuICAgIGlmICghc2lnbmVkKSB7XG4gICAgICBhd2FpdCB0aGlzLmFkYi5zaWduKGFwayk7XG4gICAgfVxuICAgIHJldHVybiAhc2lnbmVkO1xuICB9XG5cbiAgYXN5bmMgc3RhcnRTZXNzaW9uIChjYXBzKSB7XG4gICAgLy8ga2lsbCBhbnkgdWlhdXRvbWF0b3IgZXhpc3RpbmcgcHJvY2Vzc2VzXG4gICAgYXdhaXQgdGhpcy5raWxsVWlBdXRvbWF0b3JPbkRldmljZSgpO1xuXG4gICAgbG9nZ2VyLmluZm8oYFN0YXJ0aW5nIHVpYXV0b21hdG9yMiBzZXJ2ZXIgJHtVSTJfVkVSfWApO1xuXG4gICAgLy8gbGV0IGNtZCA9IFsnYW0nLCAnaW5zdHJ1bWVudCcsICctdycsXG4gICAgLy8gICAnaW8uYXBwaXVtLnVpYXV0b21hdG9yMi5zZXJ2ZXIudGVzdC9hbmRyb2lkLnN1cHBvcnQudGVzdC5ydW5uZXIuQW5kcm9pZEpVbml0UnVubmVyJ107XG4gICAgLy8gdGhpcy5hZGIuc2hlbGwoY21kKTtcbiAgICAvLyB1c2luZyAzcmQgcGFydHkgbW9kdWxlIGNhbGxlZCAnYWRiS2l0JyBmb3IgdGltZSBiZWluZyBhcyB1c2luZyAnYXBwaXVtLWFkYidcbiAgICAvLyBmYWNpbmcgSWxsZWdhbFN0YXRlRXhjZXB0aW9uOiBVaUF1dG9tYXRpb24gbm90IGNvbm5lY3RlZCBleGNlcHRpb25cbiAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vYXBwaXVtL2FwcGl1bS11aWF1dG9tYXRvcjItZHJpdmVyL2lzc3Vlcy8xOVxuXG4gICAgYXdhaXQgdGhpcy5zdGFydFNlc3Npb25Vc2luZ0FkYktpdChjYXBzLmRldmljZVVESUQpO1xuXG4gICAgbGV0IHJldHJpZXMgPSBnZXRSZXRyaWVzKCdTZXJ2ZXIgbGF1bmNoJywgY2Fwcy51aWF1dG9tYXRvcjJTZXJ2ZXJMYXVuY2hUaW1lb3V0LCBTRVJWRVJfTEFVTkNIX1JFVFJJRVMpO1xuXG4gICAgbG9nZ2VyLmluZm8oYFdhaXRpbmcgdXAgdG8gJHtyZXRyaWVzICogMTAwMH1tcyBmb3IgVWlBdXRvbWF0b3IyIHRvIGJlIG9ubGluZS4uLmApO1xuICAgIC8vIHdhaXQgZm9yIFVpQXV0b21hdG9yMiB0byBiZSBvbmxpbmVcbiAgICBhd2FpdCByZXRyeUludGVydmFsKHJldHJpZXMsIDEwMDAsIHRoaXMuandwcm94eS5jb21tYW5kLmJpbmQodGhpcy5qd3Byb3h5KSwgJy9zdGF0dXMnLCAnR0VUJyk7XG4gICAgYXdhaXQgdGhpcy5qd3Byb3h5LmNvbW1hbmQoJy9zZXNzaW9uJywgJ1BPU1QnLCB7ZGVzaXJlZENhcGFiaWxpdGllczogY2Fwc30pO1xuICB9XG5cbiAgYXN5bmMgc3RhcnRTZXNzaW9uVXNpbmdBZGJLaXQgKGRldmljZVVESUQpIHtcbiAgICBsb2dnZXIuaW5mbyhgUnVubmluZyBjb21tYW5kOiAnYWRiIC1zICR7ZGV2aWNlVURJRH0gc2hlbGwgYW0gaW5zdHJ1bWVudCAtdyAke0lOU1RSVU1FTlRBVElPTl9UQVJHRVR9J2ApO1xuICAgIHRoaXMuY2xpZW50LnNoZWxsKGRldmljZVVESUQsIGBhbSBpbnN0cnVtZW50IC13ICR7SU5TVFJVTUVOVEFUSU9OX1RBUkdFVH1gKVxuICAgICAgLnRoZW4oYWRia2l0LnV0aWwucmVhZEFsbClcbiAgICAgIC50aGVuKGZ1bmN0aW9uIChvdXRwdXQpIHtcbiAgICAgICAgZm9yIChsZXQgbGluZSBvZiBvdXRwdXQudG9TdHJpbmcoKS5zcGxpdCgnXFxuJykpIHtcbiAgICAgICAgICBpZiAobGluZS5sZW5ndGgpIHtcbiAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhgW1VJQXV0b21hdG9yMl0gJHtsaW5lfWApO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSkuY2F0Y2goZnVuY3Rpb24gKGVycikge1xuICAgICAgICBsb2dnZXIuZXJyb3IoYFtVSUF1dG9tYXRvcjIgRXJyb3JdICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgICAgIGxvZ2dlci5kZWJ1ZyhgRnVsbCBlcnJvcjogJHtlcnIuc3RhY2t9YCk7XG4gICAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIGRlbGV0ZVNlc3Npb24gKCkge1xuICAgIGxvZ2dlci5kZWJ1ZygnRGVsZXRpbmcgVWlBdXRvbWF0b3IyIHNlcnZlciBzZXNzaW9uJyk7XG4gICAgLy8gcmVseSBvbiBqd3Byb3h5J3MgaW50ZWxsaWdlbmNlIHRvIGtub3cgd2hhdCB3ZSdyZSB0YWxraW5nIGFib3V0IGFuZFxuICAgIC8vIGRlbGV0ZSB0aGUgY3VycmVudCBzZXNzaW9uXG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMuandwcm94eS5jb21tYW5kKCcvJywgJ0RFTEVURScpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nZ2VyLndhcm4oYERpZCBub3QgZ2V0IGNvbmZpcm1hdGlvbiBVaUF1dG9tYXRvcjIgZGVsZXRlU2Vzc2lvbiB3b3JrZWQ7IGAgK1xuICAgICAgICAgIGBFcnJvciB3YXM6ICR7ZXJyfWApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGtpbGxVaUF1dG9tYXRvck9uRGV2aWNlICgpIHtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5hZGIuZm9yY2VTdG9wKCdpby5hcHBpdW0udWlhdXRvbWF0b3IyLnNlcnZlcicpO1xuICAgIH0gY2F0Y2ggKGlnbm9yZSkge1xuICAgICAgbG9nZ2VyLmluZm8oXCJVbmFibGUgdG8ga2lsbCB0aGUgaW8uYXBwaXVtLnVpYXV0b21hdG9yMi5zZXJ2ZXIgcHJvY2VzcywgYXNzdW1pbmcgaXQgaXMgYWxyZWFkeSBraWxsZWRcIik7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IFVpQXV0b21hdG9yMlNlcnZlcjtcbiJdLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
