'use strict';

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

var _chai = require('chai');

var _chai2 = _interopRequireDefault(_chai);

var _chaiAsPromised = require('chai-as-promised');

var _chaiAsPromised2 = _interopRequireDefault(_chaiAsPromised);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _asyncbox = require('asyncbox');

var _desired = require('../../desired');

var _helpersSession = require('../../helpers/session');

_chai2['default'].should();
_chai2['default'].use(_chaiAsPromised2['default']);

var EDITTEXT_CLASS = 'android.widget.EditText';

var PACKAGE = 'io.appium.android.apis';
var TEXTFIELD_ACTIVITY = '.view.TextFields';

var defaultAsciiCaps = _Object$assign({}, _desired.APIDEMOS_CAPS, {
  newCommandTimeout: 90,
  appPackage: PACKAGE,
  appActivity: TEXTFIELD_ACTIVITY
});

var defaultUnicodeCaps = _Object$assign({}, defaultAsciiCaps, {
  unicodeKeyboard: true,
  resetKeyboard: true
});

function deSamsungify(text) {
  // For samsung S5 text is appended with ". Editing."
  return text.replace(". Editing.", "");
}

function runTextEditTest(driver, testText) {
  var keys = arguments.length <= 2 || arguments[2] === undefined ? false : arguments[2];
  var el;
  return _regeneratorRuntime.async(function runTextEditTest$(context$1$0) {
    var _this = this;

    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.t0 = _lodash2['default'];
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(driver.findElOrEls('class name', EDITTEXT_CLASS, true));

      case 3:
        context$1$0.t1 = context$1$0.sent;
        el = context$1$0.t0.last.call(context$1$0.t0, context$1$0.t1);

        el = el.ELEMENT;
        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(driver.clear(el));

      case 8:
        if (!keys) {
          context$1$0.next = 13;
          break;
        }

        context$1$0.next = 11;
        return _regeneratorRuntime.awrap(driver.keys([testText]));

      case 11:
        context$1$0.next = 15;
        break;

      case 13:
        context$1$0.next = 15;
        return _regeneratorRuntime.awrap(driver.setValue(testText, el));

      case 15:
        context$1$0.next = 17;
        return _regeneratorRuntime.awrap((0, _asyncbox.retryInterval)(10, 1000, function callee$1$0() {
          var text;
          return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
            while (1) switch (context$2$0.prev = context$2$0.next) {
              case 0:
                context$2$0.next = 2;
                return _regeneratorRuntime.awrap(driver.getText(el));

              case 2:
                text = context$2$0.sent;

                deSamsungify(text).should.be.equal(testText);

              case 4:
              case 'end':
                return context$2$0.stop();
            }
          }, null, _this);
        }));

      case 17:
        return context$1$0.abrupt('return', el);

      case 18:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

var tests = [{ label: 'editing a text field', text: 'Life, the Universe and Everything.' }, { label: 'sending \'&-\'', text: '&-' }, { label: 'sending \'&\' and \'-\' in other text', text: 'In the mid-1990s he ate fish & chips as mayor-elect.' }, { label: 'sending \'-\' in text', text: 'Super-test.' }, { label: 'sending numbers', text: '0123456789' }];

var unicodeTests = [{ label: 'should be able to send \'-\' in unicode text', text: 'परीक्षा-परीक्षण' }, { label: 'should be able to send \'&\' in text', text: 'Fish & chips' }, { label: 'should be able to send \'&\' in unicode text', text: 'Mīna & chips' }, { label: 'should be able to send roman characters with diacritics', text: 'Áé Œ ù ḍ' }, { label: 'should be able to send a \'u\' with an umlaut', text: 'ü' }];

var languageTests = [{ label: 'should be able to send Tamil', text: 'சோதனை' }, { label: 'should be able to send Gujarati', text: 'પરીક્ષણ' }, { label: 'should be able to send Chinese', text: '测试' }, { label: 'should be able to send Russian', text: 'тестирование' }, { label: 'should be able to send Arabic', text: 'تجريب' }, { label: 'should be able to send Hebrew', text: 'בדיקות' }];

describe('keyboard', function () {
  describe('ascii', function () {
    var driver = undefined;
    before(function callee$2$0() {
      var engines, selectedEngine, _iteratorNormalCompletion, _didIteratorError, _iteratorError, _iterator, _step, engine;

      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap((0, _helpersSession.initDriver)(defaultAsciiCaps));

          case 2:
            driver = context$3$0.sent;
            context$3$0.next = 5;
            return _regeneratorRuntime.awrap(driver.availableIMEEngines());

          case 5:
            engines = context$3$0.sent;
            selectedEngine = _lodash2['default'].first(engines);
            _iteratorNormalCompletion = true;
            _didIteratorError = false;
            _iteratorError = undefined;
            context$3$0.prev = 10;

            for (_iterator = _getIterator(engines); !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
              engine = _step.value;

              // it seems that the latin ime has `android.inputmethod` in its package name
              if (engine.indexOf('android.inputmethod') !== -1) {
                selectedEngine = engine;
              }
            }
            context$3$0.next = 18;
            break;

          case 14:
            context$3$0.prev = 14;
            context$3$0.t0 = context$3$0['catch'](10);
            _didIteratorError = true;
            _iteratorError = context$3$0.t0;

          case 18:
            context$3$0.prev = 18;
            context$3$0.prev = 19;

            if (!_iteratorNormalCompletion && _iterator['return']) {
              _iterator['return']();
            }

          case 21:
            context$3$0.prev = 21;

            if (!_didIteratorError) {
              context$3$0.next = 24;
              break;
            }

            throw _iteratorError;

          case 24:
            return context$3$0.finish(21);

          case 25:
            return context$3$0.finish(18);

          case 26:
            context$3$0.next = 28;
            return _regeneratorRuntime.awrap(driver.activateIMEEngine(selectedEngine));

          case 28:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this, [[10, 14, 18, 26], [19,, 21, 25]]);
    });
    after(function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(driver.deleteSession());

          case 2:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this);
    });

    describe('editing a text field', function () {
      var _iteratorNormalCompletion2 = true;
      var _didIteratorError2 = false;
      var _iteratorError2 = undefined;

      try {
        var _loop = function () {
          var test = _step2.value;

          describe(test.label, function () {
            it('should work with setValue', function callee$5$0() {
              return _regeneratorRuntime.async(function callee$5$0$(context$6$0) {
                while (1) switch (context$6$0.prev = context$6$0.next) {
                  case 0:
                    context$6$0.next = 2;
                    return _regeneratorRuntime.awrap(runTextEditTest(driver, test.text));

                  case 2:
                  case 'end':
                    return context$6$0.stop();
                }
              }, null, this);
            });
            it('should work with keys', function callee$5$0() {
              return _regeneratorRuntime.async(function callee$5$0$(context$6$0) {
                while (1) switch (context$6$0.prev = context$6$0.next) {
                  case 0:
                    context$6$0.next = 2;
                    return _regeneratorRuntime.awrap(runTextEditTest(driver, test.text, true));

                  case 2:
                  case 'end':
                    return context$6$0.stop();
                }
              }, null, this);
            });
          });
        };

        for (var _iterator2 = _getIterator(tests), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
          _loop();
        }
      } catch (err) {
        _didIteratorError2 = true;
        _iteratorError2 = err;
      } finally {
        try {
          if (!_iteratorNormalCompletion2 && _iterator2['return']) {
            _iterator2['return']();
          }
        } finally {
          if (_didIteratorError2) {
            throw _iteratorError2;
          }
        }
      }

      it('should be able to clear a password field', function callee$3$0() {
        var els, el;
        return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
          while (1) switch (context$4$0.prev = context$4$0.next) {
            case 0:
              context$4$0.next = 2;
              return _regeneratorRuntime.awrap(driver.findElOrEls('class name', EDITTEXT_CLASS, true));

            case 2:
              els = context$4$0.sent;
              el = els[1].ELEMENT;
              context$4$0.next = 6;
              return _regeneratorRuntime.awrap(driver.setValue('super-duper password', el));

            case 6:
              context$4$0.next = 8;
              return _regeneratorRuntime.awrap(driver.clear(el));

            case 8:
            case 'end':
              return context$4$0.stop();
          }
        }, null, this);
      });

      it('should be able to type in length-limited field', function callee$3$0() {
        var els, el, text;
        return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
          while (1) switch (context$4$0.prev = context$4$0.next) {
            case 0:
              context$4$0.next = 2;
              return _regeneratorRuntime.awrap(driver.adb.getApiLevel());

            case 2:
              context$4$0.t0 = context$4$0.sent;
              context$4$0.t1 = parseInt(context$4$0.t0, 10);

              if (!(context$4$0.t1 < 24)) {
                context$4$0.next = 6;
                break;
              }

              return context$4$0.abrupt('return', this.skip());

            case 6:
              context$4$0.next = 8;
              return _regeneratorRuntime.awrap(driver.findElOrEls('class name', EDITTEXT_CLASS, true));

            case 8:
              els = context$4$0.sent;
              el = els[3].ELEMENT;
              context$4$0.next = 12;
              return _regeneratorRuntime.awrap(driver.setValue('0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ', el));

            case 12:
              context$4$0.next = 14;
              return _regeneratorRuntime.awrap(driver.getText(el));

            case 14:
              text = context$4$0.sent;

              text.should.eql('0123456789a');

            case 16:
            case 'end':
              return context$4$0.stop();
          }
        }, null, this);
      });
    });
  });

  describe('unicode', function () {
    var driver = undefined;
    before(function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap((0, _helpersSession.initDriver)(defaultUnicodeCaps));

          case 2:
            driver = context$3$0.sent;

          case 3:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this);
    });
    after(function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(driver.deleteSession());

          case 2:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this);
    });

    describe('editing a text field', function () {
      var _arr = [tests, unicodeTests, languageTests];

      for (var _i = 0; _i < _arr.length; _i++) {
        var testSet = _arr[_i];var _iteratorNormalCompletion3 = true;
        var _didIteratorError3 = false;
        var _iteratorError3 = undefined;

        try {
          var _loop2 = function () {
            var test = _step3.value;

            describe(test.label, function () {
              it('should work with setValue', function callee$5$0() {
                return _regeneratorRuntime.async(function callee$5$0$(context$6$0) {
                  while (1) switch (context$6$0.prev = context$6$0.next) {
                    case 0:
                      context$6$0.next = 2;
                      return _regeneratorRuntime.awrap(runTextEditTest(driver, test.text));

                    case 2:
                    case 'end':
                      return context$6$0.stop();
                  }
                }, null, this);
              });
              it('should work with keys', function callee$5$0() {
                return _regeneratorRuntime.async(function callee$5$0$(context$6$0) {
                  while (1) switch (context$6$0.prev = context$6$0.next) {
                    case 0:
                      context$6$0.next = 2;
                      return _regeneratorRuntime.awrap(runTextEditTest(driver, test.text, true));

                    case 2:
                    case 'end':
                      return context$6$0.stop();
                  }
                }, null, this);
              });
            });
          };

          for (var _iterator3 = _getIterator(testSet), _step3; !(_iteratorNormalCompletion3 = (_step3 = _iterator3.next()).done); _iteratorNormalCompletion3 = true) {
            _loop2();
          }
        } catch (err) {
          _didIteratorError3 = true;
          _iteratorError3 = err;
        } finally {
          try {
            if (!_iteratorNormalCompletion3 && _iterator3['return']) {
              _iterator3['return']();
            }
          } finally {
            if (_didIteratorError3) {
              throw _iteratorError3;
            }
          }
        }
      }
    });
  });
});

// sometimes the default ime is not what we are using

// there is currently no way to assert anything about the contents
// of a password field, since there is no way to access the contents
// but this should, at the very least, not fail

// below Android 7.0 (API level 24) typing too many characters in a
// length-limited field will either throw a NullPointerException or
// crash the app

// expect first 11 characters (limit of the field) to be in the field
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvZnVuY3Rpb25hbC9jb21tYW5kcy9rZXlib2FyZC9rZXlib2FyZC1lMmUtc3BlY3MuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7OztvQkFBaUIsTUFBTTs7Ozs4QkFDSSxrQkFBa0I7Ozs7c0JBQy9CLFFBQVE7Ozs7d0JBQ1EsVUFBVTs7dUJBQ1YsZUFBZTs7OEJBQ2xCLHVCQUF1Qjs7QUFHbEQsa0JBQUssTUFBTSxFQUFFLENBQUM7QUFDZCxrQkFBSyxHQUFHLDZCQUFnQixDQUFDOztBQUV6QixJQUFNLGNBQWMsR0FBRyx5QkFBeUIsQ0FBQzs7QUFFakQsSUFBTSxPQUFPLEdBQUcsd0JBQXdCLENBQUM7QUFDekMsSUFBTSxrQkFBa0IsR0FBRyxrQkFBa0IsQ0FBQzs7QUFFOUMsSUFBSSxnQkFBZ0IsR0FBRyxlQUFjLEVBQUUsMEJBQWlCO0FBQ3RELG1CQUFpQixFQUFFLEVBQUU7QUFDckIsWUFBVSxFQUFFLE9BQU87QUFDbkIsYUFBVyxFQUFFLGtCQUFrQjtDQUNoQyxDQUFDLENBQUM7O0FBRUgsSUFBSSxrQkFBa0IsR0FBRyxlQUFjLEVBQUUsRUFBRSxnQkFBZ0IsRUFBRTtBQUMzRCxpQkFBZSxFQUFFLElBQUk7QUFDckIsZUFBYSxFQUFFLElBQUk7Q0FDcEIsQ0FBQyxDQUFDOztBQUVILFNBQVMsWUFBWSxDQUFFLElBQUksRUFBRTs7QUFFM0IsU0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLFlBQVksRUFBRSxFQUFFLENBQUMsQ0FBQztDQUN2Qzs7QUFFRCxTQUFlLGVBQWUsQ0FBRSxNQUFNLEVBQUUsUUFBUTtNQUFFLElBQUkseURBQUcsS0FBSztNQUN4RCxFQUFFOzs7Ozs7Ozt5Q0FBZ0IsTUFBTSxDQUFDLFdBQVcsQ0FBQyxZQUFZLEVBQUUsY0FBYyxFQUFFLElBQUksQ0FBQzs7OztBQUF4RSxVQUFFLGtCQUFLLElBQUk7O0FBQ2YsVUFBRSxHQUFHLEVBQUUsQ0FBQyxPQUFPLENBQUM7O3lDQUNWLE1BQU0sQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDOzs7YUFFbEIsSUFBSTs7Ozs7O3lDQUNBLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQzs7Ozs7Ozs7eUNBRXZCLE1BQU0sQ0FBQyxRQUFRLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FBQzs7Ozt5Q0FHL0IsNkJBQWMsRUFBRSxFQUFFLElBQUksRUFBRTtjQUN4QixJQUFJOzs7OztpREFBUyxNQUFNLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQzs7O0FBQS9CLG9CQUFJOztBQUNSLDRCQUFZLENBQUMsSUFBSSxDQUFDLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUM7Ozs7Ozs7U0FDOUMsQ0FBQzs7OzRDQUVLLEVBQUU7Ozs7Ozs7Q0FDVjs7QUFFRCxJQUFJLEtBQUssR0FBRyxDQUNWLEVBQUUsS0FBSyxFQUFFLHNCQUFzQixFQUFFLElBQUksRUFBRSxvQ0FBb0MsRUFBRSxFQUM3RSxFQUFFLEtBQUssRUFBRSxnQkFBZ0IsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLEVBQ3ZDLEVBQUUsS0FBSyxFQUFFLHVDQUF1QyxFQUFFLElBQUksRUFBRSxzREFBc0QsRUFBRSxFQUNoSCxFQUFFLEtBQUssRUFBRSx1QkFBdUIsRUFBRSxJQUFJLEVBQUUsYUFBYSxFQUFFLEVBQ3ZELEVBQUUsS0FBSyxFQUFFLGlCQUFpQixFQUFFLElBQUksRUFBRSxZQUFZLEVBQUMsQ0FDaEQsQ0FBQzs7QUFFRixJQUFJLFlBQVksR0FBRyxDQUNqQixFQUFFLEtBQUssRUFBRSw4Q0FBOEMsRUFBRSxJQUFJLEVBQUUsaUJBQWlCLEVBQUUsRUFDbEYsRUFBRSxLQUFLLEVBQUUsc0NBQXNDLEVBQUUsSUFBSSxFQUFFLGNBQWMsRUFBRSxFQUN2RSxFQUFFLEtBQUssRUFBRSw4Q0FBOEMsRUFBRSxJQUFJLEVBQUUsY0FBYyxFQUFFLEVBQy9FLEVBQUUsS0FBSyxFQUFFLHlEQUF5RCxFQUFFLElBQUksRUFBRSxVQUFVLEVBQUUsRUFDdEYsRUFBRSxLQUFLLEVBQUUsK0NBQStDLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxDQUN0RSxDQUFDOztBQUVGLElBQUksYUFBYSxHQUFHLENBQ2xCLEVBQUUsS0FBSyxFQUFFLDhCQUE4QixFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsRUFDekQsRUFBRSxLQUFLLEVBQUUsaUNBQWlDLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxFQUM3RCxFQUFFLEtBQUssRUFBRSxnQ0FBZ0MsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLEVBQ3ZELEVBQUUsS0FBSyxFQUFFLGdDQUFnQyxFQUFFLElBQUksRUFBRSxjQUFjLEVBQUUsRUFDakUsRUFBRSxLQUFLLEVBQUUsK0JBQStCLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxFQUN6RCxFQUFFLEtBQUssRUFBRSwrQkFBK0IsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLENBQzNELENBQUM7O0FBRUYsUUFBUSxDQUFDLFVBQVUsRUFBRSxZQUFZO0FBQy9CLFVBQVEsQ0FBQyxPQUFPLEVBQUUsWUFBWTtBQUM1QixRQUFJLE1BQU0sWUFBQSxDQUFDO0FBQ1gsVUFBTSxDQUFDO1VBSUQsT0FBTyxFQUNQLGNBQWMsa0ZBQ1QsTUFBTTs7Ozs7OzZDQUxBLGdDQUFXLGdCQUFnQixDQUFDOzs7QUFBM0Msa0JBQU07OzZDQUdjLE1BQU0sQ0FBQyxtQkFBbUIsRUFBRTs7O0FBQTVDLG1CQUFPO0FBQ1AsMEJBQWMsR0FBRyxvQkFBRSxLQUFLLENBQUMsT0FBTyxDQUFDOzs7Ozs7QUFDckMsMENBQW1CLE9BQU8scUdBQUU7QUFBbkIsb0JBQU07OztBQUViLGtCQUFJLE1BQU0sQ0FBQyxPQUFPLENBQUMscUJBQXFCLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRTtBQUNoRCw4QkFBYyxHQUFHLE1BQU0sQ0FBQztlQUN6QjthQUNGOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7NkNBQ0ssTUFBTSxDQUFDLGlCQUFpQixDQUFDLGNBQWMsQ0FBQzs7Ozs7OztLQUMvQyxDQUFDLENBQUM7QUFDSCxTQUFLLENBQUM7Ozs7OzZDQUNFLE1BQU0sQ0FBQyxhQUFhLEVBQUU7Ozs7Ozs7S0FDN0IsQ0FBQyxDQUFDOztBQUdILFlBQVEsQ0FBQyxzQkFBc0IsRUFBRSxZQUFZOzs7Ozs7O2NBQ2xDLElBQUk7O0FBQ1gsa0JBQVEsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLFlBQU07QUFDekIsY0FBRSxDQUFDLDJCQUEyQixFQUFFOzs7OztxREFDeEIsZUFBZSxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDOzs7Ozs7O2FBQ3pDLENBQUMsQ0FBQztBQUNILGNBQUUsQ0FBQyx1QkFBdUIsRUFBRTs7Ozs7cURBQ3BCLGVBQWUsQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUM7Ozs7Ozs7YUFDL0MsQ0FBQyxDQUFDO1dBQ0osQ0FBQyxDQUFDOzs7QUFSTCwyQ0FBaUIsS0FBSyxpSEFBRTs7U0FTdkI7Ozs7Ozs7Ozs7Ozs7Ozs7QUFFRCxRQUFFLENBQUMsMENBQTBDLEVBQUU7WUFJekMsR0FBRyxFQUNILEVBQUU7Ozs7OytDQURVLE1BQU0sQ0FBQyxXQUFXLENBQUMsWUFBWSxFQUFFLGNBQWMsRUFBRSxJQUFJLENBQUM7OztBQUFsRSxpQkFBRztBQUNILGdCQUFFLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU87OytDQUVqQixNQUFNLENBQUMsUUFBUSxDQUFDLHNCQUFzQixFQUFFLEVBQUUsQ0FBQzs7OzsrQ0FDM0MsTUFBTSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUM7Ozs7Ozs7T0FDdkIsQ0FBQyxDQUFDOztBQUVILFFBQUUsQ0FBQyxnREFBZ0QsRUFBRTtZQU8vQyxHQUFHLEVBQ0gsRUFBRSxFQUlGLElBQUk7Ozs7OytDQVhXLE1BQU0sQ0FBQyxHQUFHLENBQUMsV0FBVyxFQUFFOzs7OytCQUF2QyxRQUFRLGlCQUFpQyxFQUFFOztxQ0FBSSxFQUFFOzs7OztrREFJNUMsSUFBSSxDQUFDLElBQUksRUFBRTs7OzsrQ0FFSixNQUFNLENBQUMsV0FBVyxDQUFDLFlBQVksRUFBRSxjQUFjLEVBQUUsSUFBSSxDQUFDOzs7QUFBbEUsaUJBQUc7QUFDSCxnQkFBRSxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPOzsrQ0FDakIsTUFBTSxDQUFDLFFBQVEsQ0FBQyxnRUFBZ0UsRUFBRSxFQUFFLENBQUM7Ozs7K0NBRzFFLE1BQU0sQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDOzs7QUFBL0Isa0JBQUk7O0FBQ1Isa0JBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxDQUFDOzs7Ozs7O09BQ2hDLENBQUMsQ0FBQztLQUNKLENBQUMsQ0FBQztHQUNKLENBQUMsQ0FBQzs7QUFFSCxVQUFRLENBQUMsU0FBUyxFQUFFLFlBQVk7QUFDOUIsUUFBSSxNQUFNLFlBQUEsQ0FBQztBQUNYLFVBQU0sQ0FBQzs7Ozs7NkNBQ1UsZ0NBQVcsa0JBQWtCLENBQUM7OztBQUE3QyxrQkFBTTs7Ozs7OztLQUNQLENBQUMsQ0FBQztBQUNILFNBQUssQ0FBQzs7Ozs7NkNBQ0UsTUFBTSxDQUFDLGFBQWEsRUFBRTs7Ozs7OztLQUM3QixDQUFDLENBQUM7O0FBRUgsWUFBUSxDQUFDLHNCQUFzQixFQUFFLFlBQVk7aUJBQ3ZCLENBQUMsS0FBSyxFQUFFLFlBQVksRUFBRSxhQUFhLENBQUM7O0FBQXhELCtDQUEwRDtBQUFyRCxZQUFJLE9BQU8sV0FBQSxDQUFBOzs7Ozs7Z0JBQ0wsSUFBSTs7QUFDWCxvQkFBUSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsWUFBTTtBQUN6QixnQkFBRSxDQUFDLDJCQUEyQixFQUFFOzs7Ozt1REFDeEIsZUFBZSxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDOzs7Ozs7O2VBQ3pDLENBQUMsQ0FBQztBQUNILGdCQUFFLENBQUMsdUJBQXVCLEVBQUU7Ozs7O3VEQUNwQixlQUFlLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDOzs7Ozs7O2VBQy9DLENBQUMsQ0FBQzthQUNKLENBQUMsQ0FBQzs7O0FBUkwsNkNBQWlCLE9BQU8saUhBQUU7O1dBU3pCOzs7Ozs7Ozs7Ozs7Ozs7T0FDRjtLQUNGLENBQUMsQ0FBQztHQUNKLENBQUMsQ0FBQztDQUNKLENBQUMsQ0FBQyIsImZpbGUiOiJ0ZXN0L2Z1bmN0aW9uYWwvY29tbWFuZHMva2V5Ym9hcmQva2V5Ym9hcmQtZTJlLXNwZWNzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGNoYWkgZnJvbSAnY2hhaSc7XG5pbXBvcnQgY2hhaUFzUHJvbWlzZWQgZnJvbSAnY2hhaS1hcy1wcm9taXNlZCc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgcmV0cnlJbnRlcnZhbCB9IGZyb20gJ2FzeW5jYm94JztcbmltcG9ydCB7IEFQSURFTU9TX0NBUFMgfSBmcm9tICcuLi8uLi9kZXNpcmVkJztcbmltcG9ydCB7IGluaXREcml2ZXIgfSBmcm9tICcuLi8uLi9oZWxwZXJzL3Nlc3Npb24nO1xuXG5cbmNoYWkuc2hvdWxkKCk7XG5jaGFpLnVzZShjaGFpQXNQcm9taXNlZCk7XG5cbmNvbnN0IEVESVRURVhUX0NMQVNTID0gJ2FuZHJvaWQud2lkZ2V0LkVkaXRUZXh0JztcblxuY29uc3QgUEFDS0FHRSA9ICdpby5hcHBpdW0uYW5kcm9pZC5hcGlzJztcbmNvbnN0IFRFWFRGSUVMRF9BQ1RJVklUWSA9ICcudmlldy5UZXh0RmllbGRzJztcblxubGV0IGRlZmF1bHRBc2NpaUNhcHMgPSBPYmplY3QuYXNzaWduKHt9LCBBUElERU1PU19DQVBTLCB7XG4gIG5ld0NvbW1hbmRUaW1lb3V0OiA5MCxcbiAgYXBwUGFja2FnZTogUEFDS0FHRSxcbiAgYXBwQWN0aXZpdHk6IFRFWFRGSUVMRF9BQ1RJVklUWVxufSk7XG5cbmxldCBkZWZhdWx0VW5pY29kZUNhcHMgPSBPYmplY3QuYXNzaWduKHt9LCBkZWZhdWx0QXNjaWlDYXBzLCB7XG4gIHVuaWNvZGVLZXlib2FyZDogdHJ1ZSxcbiAgcmVzZXRLZXlib2FyZDogdHJ1ZVxufSk7XG5cbmZ1bmN0aW9uIGRlU2Ftc3VuZ2lmeSAodGV4dCkge1xuICAvLyBGb3Igc2Ftc3VuZyBTNSB0ZXh0IGlzIGFwcGVuZGVkIHdpdGggXCIuIEVkaXRpbmcuXCJcbiAgcmV0dXJuIHRleHQucmVwbGFjZShcIi4gRWRpdGluZy5cIiwgXCJcIik7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHJ1blRleHRFZGl0VGVzdCAoZHJpdmVyLCB0ZXN0VGV4dCwga2V5cyA9IGZhbHNlKSB7XG4gIGxldCBlbCA9IF8ubGFzdChhd2FpdCBkcml2ZXIuZmluZEVsT3JFbHMoJ2NsYXNzIG5hbWUnLCBFRElUVEVYVF9DTEFTUywgdHJ1ZSkpO1xuICBlbCA9IGVsLkVMRU1FTlQ7XG4gIGF3YWl0IGRyaXZlci5jbGVhcihlbCk7XG5cbiAgaWYgKGtleXMpIHtcbiAgICBhd2FpdCBkcml2ZXIua2V5cyhbdGVzdFRleHRdKTtcbiAgfSBlbHNlIHtcbiAgICBhd2FpdCBkcml2ZXIuc2V0VmFsdWUodGVzdFRleHQsIGVsKTtcbiAgfVxuXG4gIGF3YWl0IHJldHJ5SW50ZXJ2YWwoMTAsIDEwMDAsIGFzeW5jICgpID0+IHtcbiAgICBsZXQgdGV4dCA9IGF3YWl0IGRyaXZlci5nZXRUZXh0KGVsKTtcbiAgICBkZVNhbXN1bmdpZnkodGV4dCkuc2hvdWxkLmJlLmVxdWFsKHRlc3RUZXh0KTtcbiAgfSk7XG5cbiAgcmV0dXJuIGVsO1xufVxuXG5sZXQgdGVzdHMgPSBbXG4gIHsgbGFiZWw6ICdlZGl0aW5nIGEgdGV4dCBmaWVsZCcsIHRleHQ6ICdMaWZlLCB0aGUgVW5pdmVyc2UgYW5kIEV2ZXJ5dGhpbmcuJyB9LFxuICB7IGxhYmVsOiAnc2VuZGluZyBcXCcmLVxcJycsIHRleHQ6ICcmLScgfSxcbiAgeyBsYWJlbDogJ3NlbmRpbmcgXFwnJlxcJyBhbmQgXFwnLVxcJyBpbiBvdGhlciB0ZXh0JywgdGV4dDogJ0luIHRoZSBtaWQtMTk5MHMgaGUgYXRlIGZpc2ggJiBjaGlwcyBhcyBtYXlvci1lbGVjdC4nIH0sXG4gIHsgbGFiZWw6ICdzZW5kaW5nIFxcJy1cXCcgaW4gdGV4dCcsIHRleHQ6ICdTdXBlci10ZXN0LicgfSxcbiAgeyBsYWJlbDogJ3NlbmRpbmcgbnVtYmVycycsIHRleHQ6ICcwMTIzNDU2Nzg5J30sXG5dO1xuXG5sZXQgdW5pY29kZVRlc3RzID0gW1xuICB7IGxhYmVsOiAnc2hvdWxkIGJlIGFibGUgdG8gc2VuZCBcXCctXFwnIGluIHVuaWNvZGUgdGV4dCcsIHRleHQ6ICfgpKrgpLDgpYDgpJXgpY3gpLfgpL4t4KSq4KSw4KWA4KSV4KWN4KS34KSjJyB9LFxuICB7IGxhYmVsOiAnc2hvdWxkIGJlIGFibGUgdG8gc2VuZCBcXCcmXFwnIGluIHRleHQnLCB0ZXh0OiAnRmlzaCAmIGNoaXBzJyB9LFxuICB7IGxhYmVsOiAnc2hvdWxkIGJlIGFibGUgdG8gc2VuZCBcXCcmXFwnIGluIHVuaWNvZGUgdGV4dCcsIHRleHQ6ICdNxKtuYSAmIGNoaXBzJyB9LFxuICB7IGxhYmVsOiAnc2hvdWxkIGJlIGFibGUgdG8gc2VuZCByb21hbiBjaGFyYWN0ZXJzIHdpdGggZGlhY3JpdGljcycsIHRleHQ6ICfDgcOpIMWSIMO5IOG4jScgfSxcbiAgeyBsYWJlbDogJ3Nob3VsZCBiZSBhYmxlIHRvIHNlbmQgYSBcXCd1XFwnIHdpdGggYW4gdW1sYXV0JywgdGV4dDogJ8O8JyB9LFxuXTtcblxubGV0IGxhbmd1YWdlVGVzdHMgPSBbXG4gIHsgbGFiZWw6ICdzaG91bGQgYmUgYWJsZSB0byBzZW5kIFRhbWlsJywgdGV4dDogJ+CumuCvh+CuvuCupOCuqeCviCcgfSxcbiAgeyBsYWJlbDogJ3Nob3VsZCBiZSBhYmxlIHRvIHNlbmQgR3VqYXJhdGknLCB0ZXh0OiAn4Kqq4Kqw4KuA4KqV4KuN4Kq34KqjJyB9LFxuICB7IGxhYmVsOiAnc2hvdWxkIGJlIGFibGUgdG8gc2VuZCBDaGluZXNlJywgdGV4dDogJ+a1i+ivlScgfSxcbiAgeyBsYWJlbDogJ3Nob3VsZCBiZSBhYmxlIHRvIHNlbmQgUnVzc2lhbicsIHRleHQ6ICfRgtC10YHRgtC40YDQvtCy0LDQvdC40LUnIH0sXG4gIHsgbGFiZWw6ICdzaG91bGQgYmUgYWJsZSB0byBzZW5kIEFyYWJpYycsIHRleHQ6ICfYqtis2LHZitioJyB9LFxuICB7IGxhYmVsOiAnc2hvdWxkIGJlIGFibGUgdG8gc2VuZCBIZWJyZXcnLCB0ZXh0OiAn15HXk9eZ16fXldeqJyB9LFxuXTtcblxuZGVzY3JpYmUoJ2tleWJvYXJkJywgZnVuY3Rpb24gKCkge1xuICBkZXNjcmliZSgnYXNjaWknLCBmdW5jdGlvbiAoKSB7XG4gICAgbGV0IGRyaXZlcjtcbiAgICBiZWZvcmUoYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgZHJpdmVyID0gYXdhaXQgaW5pdERyaXZlcihkZWZhdWx0QXNjaWlDYXBzKTtcblxuICAgICAgLy8gc29tZXRpbWVzIHRoZSBkZWZhdWx0IGltZSBpcyBub3Qgd2hhdCB3ZSBhcmUgdXNpbmdcbiAgICAgIGxldCBlbmdpbmVzID0gYXdhaXQgZHJpdmVyLmF2YWlsYWJsZUlNRUVuZ2luZXMoKTtcbiAgICAgIGxldCBzZWxlY3RlZEVuZ2luZSA9IF8uZmlyc3QoZW5naW5lcyk7XG4gICAgICBmb3IgKGxldCBlbmdpbmUgb2YgZW5naW5lcykge1xuICAgICAgICAvLyBpdCBzZWVtcyB0aGF0IHRoZSBsYXRpbiBpbWUgaGFzIGBhbmRyb2lkLmlucHV0bWV0aG9kYCBpbiBpdHMgcGFja2FnZSBuYW1lXG4gICAgICAgIGlmIChlbmdpbmUuaW5kZXhPZignYW5kcm9pZC5pbnB1dG1ldGhvZCcpICE9PSAtMSkge1xuICAgICAgICAgIHNlbGVjdGVkRW5naW5lID0gZW5naW5lO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBhd2FpdCBkcml2ZXIuYWN0aXZhdGVJTUVFbmdpbmUoc2VsZWN0ZWRFbmdpbmUpO1xuICAgIH0pO1xuICAgIGFmdGVyKGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIGF3YWl0IGRyaXZlci5kZWxldGVTZXNzaW9uKCk7XG4gICAgfSk7XG5cblxuICAgIGRlc2NyaWJlKCdlZGl0aW5nIGEgdGV4dCBmaWVsZCcsIGZ1bmN0aW9uICgpIHtcbiAgICAgIGZvciAobGV0IHRlc3Qgb2YgdGVzdHMpIHtcbiAgICAgICAgZGVzY3JpYmUodGVzdC5sYWJlbCwgKCkgPT4ge1xuICAgICAgICAgIGl0KCdzaG91bGQgd29yayB3aXRoIHNldFZhbHVlJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgYXdhaXQgcnVuVGV4dEVkaXRUZXN0KGRyaXZlciwgdGVzdC50ZXh0KTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgICBpdCgnc2hvdWxkIHdvcmsgd2l0aCBrZXlzJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgYXdhaXQgcnVuVGV4dEVkaXRUZXN0KGRyaXZlciwgdGVzdC50ZXh0LCB0cnVlKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIGl0KCdzaG91bGQgYmUgYWJsZSB0byBjbGVhciBhIHBhc3N3b3JkIGZpZWxkJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgICAvLyB0aGVyZSBpcyBjdXJyZW50bHkgbm8gd2F5IHRvIGFzc2VydCBhbnl0aGluZyBhYm91dCB0aGUgY29udGVudHNcbiAgICAgICAgLy8gb2YgYSBwYXNzd29yZCBmaWVsZCwgc2luY2UgdGhlcmUgaXMgbm8gd2F5IHRvIGFjY2VzcyB0aGUgY29udGVudHNcbiAgICAgICAgLy8gYnV0IHRoaXMgc2hvdWxkLCBhdCB0aGUgdmVyeSBsZWFzdCwgbm90IGZhaWxcbiAgICAgICAgbGV0IGVscyA9IGF3YWl0IGRyaXZlci5maW5kRWxPckVscygnY2xhc3MgbmFtZScsIEVESVRURVhUX0NMQVNTLCB0cnVlKTtcbiAgICAgICAgbGV0IGVsID0gZWxzWzFdLkVMRU1FTlQ7XG5cbiAgICAgICAgYXdhaXQgZHJpdmVyLnNldFZhbHVlKCdzdXBlci1kdXBlciBwYXNzd29yZCcsIGVsKTtcbiAgICAgICAgYXdhaXQgZHJpdmVyLmNsZWFyKGVsKTtcbiAgICAgIH0pO1xuXG4gICAgICBpdCgnc2hvdWxkIGJlIGFibGUgdG8gdHlwZSBpbiBsZW5ndGgtbGltaXRlZCBmaWVsZCcsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgaWYgKHBhcnNlSW50KGF3YWl0IGRyaXZlci5hZGIuZ2V0QXBpTGV2ZWwoKSwgMTApIDwgMjQpIHtcbiAgICAgICAgICAvLyBiZWxvdyBBbmRyb2lkIDcuMCAoQVBJIGxldmVsIDI0KSB0eXBpbmcgdG9vIG1hbnkgY2hhcmFjdGVycyBpbiBhXG4gICAgICAgICAgLy8gbGVuZ3RoLWxpbWl0ZWQgZmllbGQgd2lsbCBlaXRoZXIgdGhyb3cgYSBOdWxsUG9pbnRlckV4Y2VwdGlvbiBvclxuICAgICAgICAgIC8vIGNyYXNoIHRoZSBhcHBcbiAgICAgICAgICByZXR1cm4gdGhpcy5za2lwKCk7XG4gICAgICAgIH1cbiAgICAgICAgbGV0IGVscyA9IGF3YWl0IGRyaXZlci5maW5kRWxPckVscygnY2xhc3MgbmFtZScsIEVESVRURVhUX0NMQVNTLCB0cnVlKTtcbiAgICAgICAgbGV0IGVsID0gZWxzWzNdLkVMRU1FTlQ7XG4gICAgICAgIGF3YWl0IGRyaXZlci5zZXRWYWx1ZSgnMDEyMzQ1Njc4OWFiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6QUJDREVGR0hJSktMTU5PUFFSU1RVVldYWVonLCBlbCk7XG5cbiAgICAgICAgLy8gZXhwZWN0IGZpcnN0IDExIGNoYXJhY3RlcnMgKGxpbWl0IG9mIHRoZSBmaWVsZCkgdG8gYmUgaW4gdGhlIGZpZWxkXG4gICAgICAgIGxldCB0ZXh0ID0gYXdhaXQgZHJpdmVyLmdldFRleHQoZWwpO1xuICAgICAgICB0ZXh0LnNob3VsZC5lcWwoJzAxMjM0NTY3ODlhJyk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ3VuaWNvZGUnLCBmdW5jdGlvbiAoKSB7XG4gICAgbGV0IGRyaXZlcjtcbiAgICBiZWZvcmUoYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgZHJpdmVyID0gYXdhaXQgaW5pdERyaXZlcihkZWZhdWx0VW5pY29kZUNhcHMpO1xuICAgIH0pO1xuICAgIGFmdGVyKGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIGF3YWl0IGRyaXZlci5kZWxldGVTZXNzaW9uKCk7XG4gICAgfSk7XG5cbiAgICBkZXNjcmliZSgnZWRpdGluZyBhIHRleHQgZmllbGQnLCBmdW5jdGlvbiAoKSB7XG4gICAgICBmb3IgKGxldCB0ZXN0U2V0IG9mIFt0ZXN0cywgdW5pY29kZVRlc3RzLCBsYW5ndWFnZVRlc3RzXSkge1xuICAgICAgICBmb3IgKGxldCB0ZXN0IG9mIHRlc3RTZXQpIHtcbiAgICAgICAgICBkZXNjcmliZSh0ZXN0LmxhYmVsLCAoKSA9PiB7XG4gICAgICAgICAgICBpdCgnc2hvdWxkIHdvcmsgd2l0aCBzZXRWYWx1ZScsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgYXdhaXQgcnVuVGV4dEVkaXRUZXN0KGRyaXZlciwgdGVzdC50ZXh0KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgaXQoJ3Nob3VsZCB3b3JrIHdpdGgga2V5cycsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgYXdhaXQgcnVuVGV4dEVkaXRUZXN0KGRyaXZlciwgdGVzdC50ZXh0LCB0cnVlKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG4gIH0pO1xufSk7XG4iXSwic291cmNlUm9vdCI6Ii4uLy4uLy4uLy4uLy4uIn0=
